#!/bin/bash

# This script builds deployment artifacts from source and moves
# those artifacts to ansible 'file' locations where they are then
# available to ansible.

scriptDir="$(dirname "$0")"
rootDir="$scriptDir/../../"
function main() {
  buildArtifacts
}

function buildArtifacts() {
  (
    cd "$rootDir" || exit 1
    ./gradlew \
        :spitfire-server:dropwizard-server:release \
        :game-app:game-headless:release \
        :spitfire-server:database:release
        set +x
  )
  BUILD_VERSION=$("$rootDir/.build/get-build-version")
  copyBuildArtifact "$rootDir/spitfire-server/database/build/artifacts/migrations.zip" "$scriptDir/../ansible/roles/lobby_server/files/"
  copyBuildArtifact "$rootDir/spitfire-server/dropwizard-server/build/artifacts/triplea-dropwizard-server-$BUILD_VERSION.zip" "$scriptDir/../ansible/roles/lobby_server/files/"
  copyBuildArtifact "$rootDir/game-app/game-headless/build/artifacts/triplea-game-headless-$BUILD_VERSION.zip" "$scriptDir/../ansible/roles/bot/files/"
}

function copyBuildArtifact() {
  local -r artifactSource="$1"
  local -r artifactDestinationPath="$2"

  if [ ! -f "$artifactSource" ]; then
    echo "Error: File does not exist: $artifactSource"
    exit 1
  fi

  mkdir -p "$artifactDestinationPath"
  cp -v "$artifactSource" "$artifactDestinationPath"
}

main

