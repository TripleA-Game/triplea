#!/bin/bash

set -ux

export CC_TEST_REPORTER_ID="$CODE_CLIMATE_TEST_COVERAGE_ID"

curl -L \
  https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 \
  > ./cc-test-reporter

chmod +x ./cc-test-reporter

./cc-test-reporter before-build

./gradlew -x :smoke-testing:test -parallel test jacocoTestReport

result="$?"

if [ "$result" != 0 ]; then
  exit "$result"
fi


find . -name "jacoco.xml" | sed 's|/build/jacoco.xml||' | while read -r i
do
(
  cd "$i/src/main/java" || return
  ../../../../cc-test-reporter format-coverage -t jacoco ../../../build/jacoco.xml
)
done


# We need wordsplitting to pass each filename as a separate parameter.
# Shellcheck otherwise wants us to quote the find command below and then
# each file found is passed all as a single argument (which does not work).

# shellcheck disable=SC2046
./cc-test-reporter sum-coverage $(find . -name "codeclimate.json" | tr '\n' ' ')

./cc-test-reporter upload-coverage

# upload coverage report - https://github.com/codecov/example-gradle
bash <(curl -s https://codecov.io/bash)

