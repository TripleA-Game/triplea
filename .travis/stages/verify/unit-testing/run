#!/bin/bash

set -ux

#export CC_TEST_REPORTER_ID="$CODE_CLIMATE_TEST_COVERAGE_ID"

curl -L \
  https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 \
  > ./cc-test-reporter

chmod +x ./cc-test-reporter

./cc-test-reporter before-build

./gradlew -x :smoke-testing:test -parallel test jacocoTestReport

result="$?"

if [ "$result" != 0 ]; then
  exit "$result"
fi


find . -name "jacoco.xml" | sed 's|/build/jacoco.xml||' | while read -r i
do
(
  cd "$i" || return
  ../../../../cc-test-reporter format-coverage -t jacoco ../../../build/jacoco.xml
)
done
./cc-test-reporter sum-coverage "$(find . -name "codeclimate.json")"

./cc-test-reporter upload-coverage

# upload coverage report - https://github.com/codecov/example-gradle
bash <(curl -s https://codecov.io/bash)

